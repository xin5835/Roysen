---
title: "Newyork_Taxi EDA"
author: "Roysen"
date: "12/14/2020"
output: html_document
---
# 探索性数据分析-纽约出租车行驶数据 {#eda-Newyork_Taxi}
```{r, message=FALSE}
library(tidyverse)
library(forcats)
library(corrplot)
library(lubridate)
library(geosphere)
library(patchwork)
```

#读取数据
```{r }
train <- read_csv("~/workspace/train.csv")
glimpse(train)
```
##变量解释
|序号|变量|注释|
|:---|:---|:---|
| 1|  id | ID|
| 2|  vendor_id       | 出租车公司id|
| 3|  pickup_datetime | 上车时间|
| 4|  dropoff_datetime| 下车时间|
| 5|  passenger_count | 乘客人数|
| 6|  pickup_longitude| 上车经度|
| 8|  pickup_latitude | 上车纬度|
| 9|  dropoff_longitude | 下车经度|
| 10|  dropoff_latitude | 下车维度|
| 11|  store_and_fwd_flag| 是否分享行程记录 Y=是，N= 不|
| 12|  trip_duration | 旅行时间（秒)|

##案例分析
数据共有观测145万多行，变量12个,是一个非常大的数据集，抽取一个10000行的样本进行分析。
从11个变量的数据纬度来看，主要是关于纽约出租车用户出行时间、地点、人数，是否分享行程记录的数据，分析思路偏向用户画像分析。
*整体出行用户的时间和距离分布描述，并结合vendor_id查看两家公司的差异性
*不同乘客人数占比分析，看看出行用户中，单人还是多人出行人数最多
*描述用户行程记录分享数据
*计算速度，分析拥堵状况在全年、星期、每日的各自表现情况
*可结合地图包分析用户上车和下车主要集中在哪些区域，哪些区域拥堵，有没有躲避拥堵的有效方案


检查缺失值
```{r}
train %>% 
  summarise(
    across(everything(), ~sum(is.na(.)))
  )
```
没有缺失值，太好了。



按行随机抽样10，000人
```{r}
set.seed(1110)
test <- sample_n(train, 10000)
```




#提取经纬度变量，将经纬度转换为距离（km），并添加到数据框中
```{r }
pickup_location <- test %>%
    select(pickup_longitude,pickup_latitude)
dropoff_location <- test %>% 
    select(dropoff_longitude,dropoff_latitude)

test <- test %>%
    mutate(distance = distHaversine(pickup_location,dropoff_location)/1000)
```


```{r }
test <- test %>% 
  mutate(speed = distance/trip_duration*3600)

```

#日期格式转换，将vendor_id作为因子，添加速度（km/h）列
```{r}
test <- test %>% 
    mutate(store_and_fwd_flag = factor(store_and_fwd_flag),
           pickup_datetime = ymd_hms(pickup_datetime),
           dropoff_datetime = ymd_hms(dropoff_datetime),
           vendor_id = factor(vendor_id))
  
test

```


#日期处理，将日期转换为数据型，并按年月周日拆分日期
```{r}
test <- test %>% 
    mutate(month = as.integer(month(pickup_datetime)),
           hour = hour(pickup_datetime),
           wday = wday(pickup_datetime))

summary(test)
```

##查看有无异常值
```{r}
test %>% 
  mutate(h_trip = trip_duration/3600) %>% 
  select(distance, speed, h_trip) %>% 
  arrange(-speed,distance, h_trip)
test %>% 
  mutate(h_trip = trip_duration/3600) %>% 
  select(distance, speed, h_trip) %>% 
  arrange(-h_trip, speed, distance)
test1 <- test %>% 
  mutate(h_trip = trip_duration/3600) %>% 
  filter(h_trip < 23 & speed < 280)

```
速度大于280km/h几乎不可能，行驶时长超过23h可能性也不大。因而删除掉这部分数据。



##乘客人数分析
```{r}
p1 <- test1 %>% 
ggplot(aes(passenger_count, fill = I("red"))) +
    geom_bar(aes(x = reorder(passenger_count, passenger_count, length))) +
    labs(title = "barplot of passenger")
p2 <- test1 %>% 
ggplot(aes(x = reorder(passenger_count, passenger_count, length), fill = vendor_id)) +
    geom_bar( position = "dodge") +
    labs(title = "barplot of passenger on vendor_id ")
p1+p2
```
1个乘客的人数超过7000人，2个乘客的人数约1300人，4人最少，5人和6人的乘客出行人数排在第三名。
从两家公司来看，出行乘客人数数据相差不大，仅仅只有第二组公司有5人和六人的乘客，或许是因为只有他们在做多人出行业务




#多人出行分组统计
```{r, message = FALSE}
filter(test1, passenger_count>4) %>% 
    group_by(month) %>%  
    summarise(number = sum(passenger_count)) %>% 
  ggplot(aes(month, number, fill = "green"))+
  geom_histogram(stat = "identity")
```
在6个月中5人和6人乘车人数比较平稳



#转发行程人数远小于100人，其中6人乘客无人转发行程
```{r}
test1 %>% 
  filter(store_and_fwd_flag == "Y") %>% 
  count()
test1 %>% 
ggplot(aes(passenger_count, fill = store_and_fwd_flag))+
    geom_bar(position = "dodge")+
    labs(title = "store_and_fwd_flag")+
    scale_y_sqrt()
    

```
分享行程的人数只有42人，这42人分布在乘客人数4人以下的组中，说明大部分乘客还是不愿意分享自己的行程数据。


#行驶距离（可能服从右偏的正态分布）
```{r}
test1 %>%
  select(distance) %>% 
  summarise(mean = mean(distance),
            sd = sd(distance))
true.mean <- 3.421247
true.sd <- 3.829957
test1 %>% 
ggplot(aes(distance))+
    geom_density(fill = "skyblue")+
    geom_vline(
    xintercept = true.mean,
    color = "red",
    linetype = "dashed"
  )+
    labs(title = "density of distance")
```
样本均值为3.42km，分布呈右偏，远距离极大的拉高了均值，大部分用户的行驶距离没有超过3.42km。




#对出租车公司进行分组，查看行驶距离是否有差异
```{r}
p1 <- test1 %>% 
ggplot(aes(distance, fill = vendor_id, alpha = 0.6))+
    geom_density()+
    labs(title = "density of distance on vendor_id")
    
p2 <- test1 %>% 
ggplot(aes(speed, fill = vendor_id, alpha = 0.6))+
    geom_density()+
    labs(title = "density of speed on vendor_id")

p3 <- test1 %>% 
ggplot(aes(trip_duration, fill = vendor_id, alpha = 0.6))+
    geom_density()+
    labs(title = "density of trip_duration on vendor_id")+
    theme(plot.title = element_text(hjust = 0.5))
p1/p2/p3
```
重叠非常严重，可以看出两家出租车公司在行驶距离、速度和旅行时长方面差异不大，短途用车和拥堵问题是一个共性的情况。


#上下车时间大体正常，1月底左右无人打车，1组和2组分布差异不大
```{r}
test1 %>% 
  select(speed) %>%  
  summarise(true.mean = mean(speed))

true.mean = 14.31743	

test1 %>% 
ggplot(aes(speed))+
    geom_density( fill = "blue")+
    geom_vline(
    xintercept = true.mean,
    color = "red",
    linetype = "dashed")+
    labs(title = "density of speed ")
```


#上下时间对比
```{r}
p1 <- ggplot(test1,aes(pickup_datetime,fill = "red"))+
    geom_histogram( bins = 200)
p2 <- ggplot(test1,aes(dropoff_datetime,fill = "red"))+
    geom_histogram(bins = 200)
p1/p2
```
上车和对应的下车时间大体分布是均匀的，奇怪的是一月底二月初打车人很少，谷歌显示因为城市遭遇暴风雪


##看看从周一到周日打车人数的变化
```{r}
test1 %>% 
    ggplot(aes(wday))+
    geom_bar(fill = "red")
```
从周一天到周日打车人数变化不大，周一和周二人数相对少些


##看看一年中每天的乘客人数分布
```{r}
test1 %>%
  mutate(hpick = hour(pickup_datetime),
         Month = factor(month(pickup_datetime, label = TRUE))) %>% 
group_by(hpick, Month) %>%
  count() %>%
  ggplot(aes(hpick, n, color = Month)) +
  geom_line(size = 1.5) +
  labs(x = "Hour of one day", y = "count")
```
除了凌晨（2:00-6:00）都是高峰，晚19:00-21:00为打车人数最多的时间，夜生活丰富


#打车时长
```{r}
test1 %>% 
ggplot(aes(trip_duration))+
    geom_histogram(bins = 500,fill = "green")

```




#车速与乘客人数、月份、周无关，与每日具体几点钟有关（凌晨车少，车速快）
```{r}
test1 %>% 
    ggplot(aes(speed,color = factor(passenger_count)))+
    geom_freqpoly(size = 1.5)

test1 %>% 
    ggplot(aes(speed,color = factor(wday)))+
    geom_freqpoly(size = 1.5)

test1 %>% 
    ggplot(aes(speed,color = factor(month)))+
    geom_freqpoly(size = 1.5)

test1 %>% 
    ggplot(aes(speed,color = factor(hour)))+
    geom_freqpoly(size = 1.5)  

test1 %>% 
  ggplot(aes(month, speed,color = factor(hour)))+
  geom_boxplot() 
```


#大体距离与速度无关，意味着不管开多远，速度变化不大
```{r}
ggplot(test1,aes(speed, distance))+
    geom_point()+
    geom_jitter()
```


距离的远近和行驶速度之间看不到线性关系
```{r}
ggplot(test1,aes(speed, distance))+
  geom_point()+
  geom_smooth()+
  scale_x_log10()+
  scale_y_log10()
```




```{r}
test_cor <- test1 %>% 
  select(where(is.numeric)) %>%  
  cor(method = "spearman") %>%
  corrplot(type = "lower")
```
行驶小时数和行驶距离距离呈现强相关关系，上下车时间呈现相关关系，上下车纬度呈现相关关系。




#结论
1.纽约是一个繁忙的城市，出租车业务不论哪一个月份，哪一个星期，哪一天没有大的差异；

2.纽约是一个不夜城。仅仅在每日凌晨2:00-5:00乘客人数较少，但并不是没有，其他每日时间段打车人数都很多，区别不大；

3纽约是一个拥堵的城市，平均车速15km/h，一年中车速集中在0-50km/h，可以说不论什么地方什么时间，要想让车速超过50km/h是一件不容易的事；

4.短程车的乘客占比极高，行程以5km内居多，这与纽约拥堵的路况也是分不开的，从场景上看打车的范围距离都很近，可能是上下班更换交通工具等情况；
5.多人（大于4人）出行具有一定的市场，6个月内呈现小范围波动的增长趋势。

6.异常数据。 一月底二月初，基本无人打车，谷歌显示因为暴风雪天气。






